
using AutoFixture;

using FluentAssertions;

using Microsoft.Extensions.DependencyInjection;

using Rent.Vehicles.Consumers.Commands.BackgroundServices;
using Rent.Vehicles.Consumers.Events.BackgroundServices;
using Rent.Vehicles.Consumers.IntegrationTests.ClassFixtures;
using Rent.Vehicles.Messages;
using Rent.Vehicles.Messages.Commands;
using Rent.Vehicles.Producers.Interfaces;
using Rent.Vehicles.Services.DataServices.Interfaces;
using Rent.Vehicles.Services.Interfaces;

using Xunit.Abstractions;

namespace Rent.Vehicles.Consumers.IntegrationTests.BackgroundServices;

[Collection(nameof(CommonCollection))]
public class UpdateUserLicenseImageCommandBackgroundServiceTests
{
    private readonly Fixture _fixture;

    private readonly CommonFixture _classFixture;

    public UpdateUserLicenseImageCommandBackgroundServiceTests(CommonFixture classFixture)
    {
        _fixture = new Fixture();
        _classFixture = classFixture;
    }

    private const string _pngBase64String = "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";

    private const string _bmpBase64String = "Qk28FQAAAAAAADYEAAAoAAAAAAEAAAABAAABAAgAAQAAAIYRAAASCwAAEgsAAAABAAAAAQAAAAAAAAAAgAAAgAAAAICAAIAAAACAAIAAgIAAAMDAwADA3MAA8MqmAAAgQAAAIGAAACCAAAAgoAAAIMAAACDgAABAAAAAQCAAAEBAAABAYAAAQIAAAECgAABAwAAAQOAAAGAAAABgIAAAYEAAAGBgAABggAAAYKAAAGDAAABg4AAAgAAAAIAgAACAQAAAgGAAAICAAACAoAAAgMAAAIDgAACgAAAAoCAAAKBAAACgYAAAoIAAAKCgAACgwAAAoOAAAMAAAADAIAAAwEAAAMBgAADAgAAAwKAAAMDAAADA4AAA4AAAAOAgAADgQAAA4GAAAOCAAADgoAAA4MAAAODgAEAAAABAACAAQABAAEAAYABAAIAAQACgAEAAwABAAOAAQCAAAEAgIABAIEAAQCBgAEAggABAIKAAQCDAAEAg4ABAQAAAQEAgAEBAQABAQGAAQECAAEBAoABAQMAAQEDgAEBgAABAYCAAQGBAAEBgYABAYIAAQGCgAEBgwABAYOAAQIAAAECAIABAgEAAQIBgAECAgABAgKAAQIDAAECA4ABAoAAAQKAgAECgQABAoGAAQKCAAECgoABAoMAAQKDgAEDAAABAwCAAQMBAAEDAYABAwIAAQMCgAEDAwABAwOAAQOAAAEDgIABA4EAAQOBgAEDggABA4KAAQODAAEDg4ACAAAAAgAAgAIAAQACAAGAAgACAAIAAoACAAMAAgADgAIAgAACAICAAgCBAAIAgYACAIIAAgCCgAIAgwACAIOAAgEAAAIBAIACAQEAAgEBgAIBAgACAQKAAgEDAAIBA4ACAYAAAgGAgAIBgQACAYGAAgGCAAIBgoACAYMAAgGDgAICAAACAgCAAgIBAAICAYACAgIAAgICgAICAwACAgOAAgKAAAICgIACAoEAAgKBgAICggACAoKAAgKDAAICg4ACAwAAAgMAgAIDAQACAwGAAgMCAAIDAoACAwMAAgMDgAIDgAACA4CAAgOBAAIDgYACA4IAAgOCgAIDgwACA4OAAwAAAAMAAIADAAEAAwABgAMAAgADAAKAAwADAAMAA4ADAIAAAwCAgAMAgQADAIGAAwCCAAMAgoADAIMAAwCDgAMBAAADAQCAAwEBAAMBA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Qf4TABzgCQAoTwAAJk8KABzgEwBB/hMAHOAJAChPAAAmTwoAHOATAEH+EwAc4AkAKE8AACZPCgAc4BMAQf4TABzgCQAoTwAAJk8KABzgEwBB/hMAHOAJAChPAAAmTwoAEuAdAEH+HAAT4AkAKE8AACZPCgAS4B0AQf4cABPgCQAoTwAAJk8KABLgHQBB/hwAE+AJAChPAAAmTwoAEuAdAEH+HAAT4AkAKE8AACZPCgAS4B0AQf4cABPgCQAoTwAAJk8KABLgHQBB/hwAE+AJAChPAAAmTwoAEuAdAEH+HAAT4AkAKE8AACZPCgAS4B0AQf4cABPgCQAoTwAAJk8KABLgHQBB/hwAE+AJAChPAAAmTwoAHOAJ/goAQf4KAAn+HOAJAChPAAAmTwoAHOAJ/goAQf4KAAn+HOAJAChPAAAmTwoAHOAJ/goAQf4KAAn+HOAJAChPAAAmTwoAHOAJ/goAQf4KAAn+HOAJAChPAAAmTwoAHOAJ/goAQf4KAAn+HOAJAChPAAAmTwoAHOAJ/goAQf4KAAn+HOAJAChPAAAmTwoAHOAJ/goAQf4KAAn+HOAJAChPAAAmTwoAHOAJ/goAQf4KAAn+HOAJAChPAAAmTwoAHOAJ/goAQf4KAAn+HOAJAChPAAAwTwkAE+Al/i8AE/4T4AkAMU8AADBPCQAT4CX+LwAT/hPgCQAxTwAAME8JABPgJf4vABP+E+AJADFPAAAwTwkAE+Al/i8AE/4T4AkAMU8AADBPCQAT4CX+LwAT/hPgCQAxTwAAME8JABPgJf4vABP+E+AJADFPAAAwTwkAE+Al/i8AE/4T4AkAMU8AADBPCQAT4CX+LwAT/hPgCQAxTwAAME8JABPgJf4vABP+E+AJADFPAAAwTwkAE+Al/i8AE/4T4AkAMU8AADBPCQAJ4Cb+CQAvvwoAEv4K4AkAMU8AADBPCQAJ4Cb+CQAvvwoAEv4K4AkAMU8AADBPCQAJ4Cb+CQAvvwoAEv4K4AkAMU8AADBPCQAJ4Cb+CQAvvwoAEv4K4AkAMU8AADBPCQAJ4Cb+CQAvvwoAEv4K4AkAMU8AADBPCQAJ4Cb+CQAvvwoAEv4K4AkAMU8AADBPCQAJ4Cb+CQAvvwoAEv4K4AkAMU8AADBPCQAJ4Cb+CQAvvwoAEv4K4AkAMU8AADBPCQAJ4Cb+CQAvvwoAEv4K4AkA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";

    [Theory]
    [InlineData(_pngBase64String, "299d8904e674332b32d2fc1c7fcf26ce.png")]
    [InlineData(_bmpBase64String, "c23ff0fb8955b91ef38bf12ffcd80c00.bmp")]
    public async Task UpdateUserLicenseImageCommandVerifyImageAreUplodad(string base64String, string name)
    {
        var cancellationTokenSource = new CancellationTokenSource(TimeSpan.FromSeconds(60));

        var periodicTimer = new PeriodicTimer(TimeSpan.FromSeconds(5));

        var command = _fixture
            .Build<UpdateUserLicenseImageCommand>()
                .With(x => x.LicenseImage, base64String)
            .Create();

        await _classFixture.GetRequiredService<IPublisher>()
            .PublishCommandAsync(command, cancellationTokenSource.Token);

        await _classFixture.GetRequiredService<UpdateUserLicenseImageCommandBackgroundService>()
            .StartAsync(cancellationTokenSource.Token);

        await _classFixture.GetRequiredService<UpdateUserLicenseImageEventBackgroundService>()
            .StartAsync(cancellationTokenSource.Token);

        await _classFixture.GetRequiredService<UploadUserLicenseImageEventBackgroundService>()
            .StartAsync(cancellationTokenSource.Token);

        var commandDataService = _classFixture.GetRequiredService<ICommandDataService>();

        var streamUploadService = _classFixture.GetRequiredService<IStreamUploadService>();

        var found = false;

        do
        {
            var commandResult = await commandDataService
                .GetAsync(x => x.SagaId == command.SagaId, cancellationTokenSource.Token);

            var nameResult = await streamUploadService
                .GetNameAsync(base64String, cancellationTokenSource.Token);

            found = commandResult.IsSuccess &&
                nameResult.IsSuccess &&
                nameResult.Value! == name &&
                streamUploadService.Bytes.SequenceEqual(Convert.FromBase64String(base64String));

            await periodicTimer.WaitForNextTickAsync(cancellationTokenSource.Token);
        } while (!found && !cancellationTokenSource.IsCancellationRequested);

        // Assert
        found.Should().BeTrue();

        await _classFixture.GetRequiredService<UploadUserLicenseImageEventBackgroundService>()
            .StopAsync(cancellationTokenSource.Token);

        await _classFixture.GetRequiredService<UpdateUserLicenseImageEventBackgroundService>()
            .StopAsync(cancellationTokenSource.Token);
        
        await _classFixture.GetRequiredService<UpdateUserLicenseImageCommandBackgroundService>()
            .StopAsync(cancellationTokenSource.Token);
    }
}
